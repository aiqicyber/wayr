<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WAYR ‚Äî Your Saved Profiles</title>
  <script src="https://unpkg.com/localbase/dist/localbase.dev.js"></script>

  <style>
    :root {
      --max-width: 920px;
      --muted: #666;
    }

    html,body {
      margin: 0;
      padding: 0;
      font-family: "Lucida Grande","Lucida Sans Unicode","Lucida Sans",Geneva,Verdana,sans-serif;
      color: #0b0b0b;
      background: #fff;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap {
      max-width: var(--max-width);
      margin: 48px auto;
      padding: 0 28px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 36px;
    }

    .logo {
      font-weight: 700;
      font-size: 20px;
      text-decoration: none;
      color: inherit;
      letter-spacing: 1px;
    }
    .logo:hover {
      text-decoration: underline;
    }

    nav {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 14px;
    }

    nav a {
      color: #111;
      text-decoration: none;
      opacity: 0.9;
    }

    .btn-ghost {
      border-radius: 10px;
      border: none;
      padding: 10px 14px;
      font-size: 20px;
      cursor: pointer;
      background: #000;
      color: #fff;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 18px;
    }
.user-list {
  display: flex;
  flex-wrap: nowrap;
  gap: 20px;
  padding: 20px 60px; 
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  position: relative;
  scrollbar-width: none; 
  z-index: 10;
      }

.user-list::-webkit-scrollbar {
  display: none;
    }

.user-list::before {
  left: 0;
  background: linear-gradient(to right, white 0%, transparent 100%);
  border-top-left-radius: 24px;
  border-bottom-left-radius: 24px;
}

.user-list::after {
  right: 0;
  background: linear-gradient(to left, white 0%, transparent 100%);
  border-top-right-radius: 24px;
  border-bottom-right-radius: 24px;
}

.user-list::before,
.user-list::after {
  filter: blur(0.2px);
}

.user-card {
  flex: 0 0 auto; 
  width: 220px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  padding: 16px;
  text-align: center;
  transition: all 0.25s ease;
  cursor: pointer;
  position: relative;
  z-index: 10;


    }

.user-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.12);
  z-index: 2;
    }

.user-card img {
   width: 100%;
   height: 200px;
   object-fit: contain;
  border-radius: 12px;
  background-color: #f9f9f9;
   margin-bottom: 12px;
    }

.user-card h3 {
   margin: 0;
   font-size: 16px;
   font-weight: 600;
    }

@media (max-width: 700px) {
.user-card {
    width: 160px;
      }
    }

    a:focus, button:focus {
      outline: 3px solid rgba(0,0,0,0.08);
      outline-offset: 3px;
    }
    .expanded-profile {
      max-width: 520px;
      margin: 40px auto 0;
      padding: 24px;
      border-radius: 20px;
      background: white;
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      transform: translateY(40px) scale(0.95);
      opacity: 0;
      transition: all 0.4s ease;
    }

    .expanded-profile.show {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .expanded-profile img {
      width: 100%;
      max-height: 320px;
      object-fit: contain;
      border-radius: 16px;
      background: #f5f5f5;
      margin-bottom: 16px;
    }

    .expanded-profile h2 {
      margin: 0 0 12px;
      text-align: center;
    }

    .reflection {
      margin-top: 16px;
    }

    .reflection h4 {
      margin: 12px 0 6px;
      font-size: 14px;
      color: #444;
    }

    .reflection p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .hidden {
      display: none;
    }

    /* slider displayyyyyyhhh 4 spectrum tingz */
    .perspective-block {
      margin-top: 20px;
    }

    .perspective-label {
      font-size: 13px;
      color: #444;
      margin-bottom: 6px;
    }

    .perspective-track {
      position: relative;
      height: 4px;
      background: #ddd;
      border-radius: 4px;
    }

    .perspective-dot {
      position: absolute;
      top: 50%;
      width: 14px;
      height: 14px;
      background: #000;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .compare-btn {
      display: block;
      margin: 40px auto 0;
      padding: 14px 22px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-size: 15px;
    }
    .compare-modal {
      position: relative;
      inset: auto;
      display: block;
      z-index: 20;

      background: none;
      backdrop-filter: none;

      opacity: 0;
      pointer-events: none;

      transition:
        opacity 0.4s ease,
        backdrop-filter 0.4s ease,
        background 0.4s ease;
    }
    .compare-modal:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }


    .compare-modal.hidden {
       opacity: 0;
      pointer-events: none;
  }

    .compare-box {
      background: white;
      padding: 24px;
      margin: 40px auto 0;
      border-radius: 20px;
      width: 520px;
      max-width: 90%;
      pointer-events: auto;
      margin-top: 80px;
      transform: translateY(40px) scale(0.95);
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.35s ease;
    }

    .compare-modal:not(.hidden) .compare-box {
        transform: translateY(0) scale(1);
        opacity: 1;
}
    .compare-slots {
      display: flex;
      gap: 16px;
      margin: 20px 0;
    }

    .slot {
      flex: 1;
      min-height: 180px;
      border: 2px dashed #ccc;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 13px;
      color: #777;
      gap: 8px;
      padding: 10px;
      }



    .slot img {
      width: 100%;
      max-height: 120px;
      object-fit: contain;
      border-radius: 10px;
      background: #f6f6f6;
    }


    #analyseBtn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      background: #000;
      color: white;
      border: none;
      cursor: pointer;
    }

    #analysisResult {
      margin-top: 18px;
      font-size: 14px;
    }
    .blur-layer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 5;
    }

    .blur-layer.show {
      opacity: 1;
    }


  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="logo" href="home.html">WAYR</a>
      <nav>
        <a href="resources.html">Resources</a>
        <a class="btn-ghost" aria-label="You">You!</a>
      </nav>
    </header>

    <div id="lockScreen">
  <h2>üîí Enter password</h2>
  <input id="passwordInput" type="password" placeholder="Password">
  <button id="unlockBtn">Unlock</button>
  <p id="lockError" style="color:red; display:none;">Wrong password</p>
</div>

<div id="appContent" class="hidden">
    <main>
      <h1>You Archives</h1>
      <p style="color:#666; margin-top:-6px;">
        Click on a card to see you then.
      </p>
      <div id="userList" class="user-list"></div>
      <div id="expandedProfile" class="expanded-profile hidden"></div>
      <button id="compareBtn" class="compare-btn">
        How have you changed?
        <div style="font-size:12px; opacity:.8;">
          compare 2 cards for similarity analysis.
        </div>
      </button>
      <div id="compareModal" class="compare-modal hidden">
        <div class="compare-box">
          <h2>Compare Selves</h2>

          <div class="compare-slots">
            <div class="slot" id="slotA">Click a card</div>
            <div class="slot" id="slotB">Click another card</div>
          </div>

          <button id="analyseBtn" disabled>Analyse!</button>
          <div id="analysisResult"></div>
        </div>
      </div>

    </main>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<script>
  let archivePassword = localStorage.getItem('archivePassword')
  let db = new Localbase('db')
  const expandedProfile = document.getElementById('expandedProfile')
  expandedProfile.addEventListener('click', e => {
    e.stopPropagation()
})

  const container = document.getElementById('userList')
 
  let selectedA = null
  let selectedB = null


 document.getElementById('compareBtn').addEventListener('click', () => {
  selectedA = null
  selectedB = null

  document.getElementById('slotA').innerHTML = 'Click a card'
  document.getElementById('slotB').innerHTML = 'Click another card'
  document.getElementById('analyseBtn').disabled = true
  document.getElementById('analysisResult').innerHTML = ''

  document.getElementById('blurLayer').classList.add('show')
  document.getElementById('compareModal').classList.remove('hidden')
})
  document.getElementById('compareModal').addEventListener('click', e => {
  if (e.target.id === 'compareModal') {
    e.target.classList.add('hidden')
    document.getElementById('blurLayer').classList.remove('show')
  }
})
    document.getElementById('analyseBtn').addEventListener('click', () => {
      const textA = Object.values(selectedA.reflections)
        .map(r => r.answer).join(' ')
      const textB = Object.values(selectedB.reflections)
        .map(r => r.answer).join(' ')

      const textScore = jaccardSimilarity(textA, textB)

      drawingSimilarity(selectedA.drawing, selectedB.drawing)
        .then(drawingScore => {
          document.getElementById('analysisResult').innerHTML = `
            <p><strong>Reflection similarity:</strong> ${(textScore * 100).toFixed(1)}%</p>
            <p><strong>Visual similarity:</strong> ${(drawingScore * 100).toFixed(1)}%</p>
            <p style="margin-top:10px; color:#666;">
              You‚Äôve changed, but some patterns remain.
            </p>
          `
        })
    })

  let masterPassword = null

  const lockScreen = document.getElementById('lockScreen')
  const appContent = document.getElementById('appContent')
  const unlockBtn = document.getElementById('unlockBtn')
  const passwordInput = document.getElementById('passwordInput')
  const lockError = document.getElementById('lockError')
  lockScreen.style.display = 'block'
  appContent.classList.add('hidden')

  unlockBtn.addEventListener('click', tryUnlock)
  passwordInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') tryUnlock()
  })

  function tryUnlock() {
    const pw = passwordInput.value.trim()
    if (!pw) return

    db.collection('users').limit(1).get().then(users => {
      if (users.length === 0) {
        unlockSuccess(pw)
        return
      }

      try {
        decryptData(users[0].payload, pw)
        unlockSuccess(pw)
      } catch {
        lockError.style.display = 'block'
      }
    })
  }

  function unlockSuccess(pw) {
    masterPassword = pw
    lockScreen.style.display = 'none'
    appContent.classList.remove('hidden')
    lockError.style.display = 'none'

    loadAndRenderUsers()
  }
  function loadAndRenderUsers() {
    db.collection('users').orderBy('id', 'desc').get().then(users => {
      if (users.length === 0) {
        container.innerHTML = "<p style='color:#666;'>No saved profiles yet. Create one first!</p>"
        return
      }

      users.forEach(user => {

        let decrypted
        try {
          decrypted = decryptData(user.payload, masterPassword)
        } catch {
          alert('Wrong password')
          throw new Error('Bad password')
        }

        const card = document.createElement('div')
        card.className = 'user-card'

        const img = document.createElement('img')
        img.src = decrypted.drawing || ''
        img.alt = decrypted.name + "'s drawing"

        const name = document.createElement('h3')
        name.textContent = decrypted.name

        card.appendChild(img)
        card.appendChild(name)
        container.appendChild(card)

        card.addEventListener('click', (e) => {
          e.stopPropagation() // IMPORTANT
          if (!document.getElementById('compareModal').classList.contains('hidden')) {
            if (!selectedA) {
              selectedA = decrypted
              document.getElementById('slotA').innerHTML =
                `
                  <img src="${decrypted.drawing}">
                  <div style="font-size:12px; color:#555;">${decrypted.name}</div>
  `

            } else if (!selectedB && user !== selectedA) {
              selectedB = decrypted
              document.getElementById('slotB').innerHTML =
                `
                  <img src="${decrypted.drawing}">
                  <div style="font-size:12px; color:#555;">${decrypted.name}</div>
  `
            }

            if (selectedA && selectedB) {
              document.getElementById('analyseBtn').disabled = false
            }

            return
          }

          expandedProfile.classList.remove('hidden')

          const perspectiveValue = decrypted.perspective?.value ?? 50

          expandedProfile.innerHTML = `
            <img src="${decrypted.drawing || ''}">
            <h2>${decrypted.name}</h2>

            <div class="reflection">
              <h4>${decrypted.reflections?.identity?.question || 'Identity'}</h4>
              <p>${decrypted.reflections?.identity?.answer || '-'}</p>

              <h4>${decrypted.reflections?.growth?.question || 'Growth'}</h4>
              <p>${decrypted.reflections?.growth?.answer || '-'}</p>

              <h4>${decrypted.reflections?.honesty?.question || 'Honesty'}</h4>
              <p>${decrypted.reflections?.honesty?.answer || '-'}</p>
            </div>

            <div class="perspective-block">
              <div class="perspective-label">
                Prefers clarity, stability ‚Üê‚Üí Comfortable with ambiguity, change
              </div>

              <div class="perspective-track">
                <div
                  class="perspective-dot"
                  style="left: ${perspectiveValue}%;"
                ></div>
              </div>
            </div>
          `

          expandedProfile.classList.remove('show')
          void expandedProfile.offsetWidth
          expandedProfile.classList.add('show')

          expandedProfile.scrollIntoView({ behavior: 'smooth', block: 'center' })
        })
      })
    })
  }
  document.addEventListener('click', (e) => {
    if (!expandedProfile.contains(e.target) && !e.target.closest('.user-card')) {
      expandedProfile.classList.add('hidden')
      expandedProfile.classList.remove('show')
    }
  })
  function encryptData(data, password) {
    return CryptoJS.AES.encrypt(
      JSON.stringify(data),
      password
    ).toString()
  }

  function decryptData(cipherText, password) {
    const bytes = CryptoJS.AES.decrypt(cipherText, password)
    const decrypted = bytes.toString(CryptoJS.enc.Utf8)
    if (!decrypted) throw new Error('Wrong password')
    return JSON.parse(decrypted)
  }

  function jaccardSimilarity(textA, textB) {
    if (!textA || !textB) return 0
  const setA = new Set(textA.toLowerCase().split(/\W+/))
  const setB = new Set(textB.toLowerCase().split(/\W+/))

  const intersection = [...setA].filter(x => setB.has(x))
  const union = new Set([...setA, ...setB])
  return intersection.length / union.size
}


function drawingSimilarity(imgSrcA, imgSrcB) {
  return new Promise(resolve => {
    const size = 200

    const canvasA = document.createElement('canvas')
    const canvasB = document.createElement('canvas')
    canvasA.width = canvasB.width = size
    canvasA.height = canvasB.height = size

    const ctxA = canvasA.getContext('2d')
    const ctxB = canvasB.getContext('2d')

    const imgA = new Image()
    const imgB = new Image()
    imgA.crossOrigin = 'anonymous'
    imgB.crossOrigin = 'anonymous'

    imgA.onload = () => {
      ctxA.fillStyle = 'white'
      ctxA.fillRect(0, 0, size, size)
      ctxA.drawImage(imgA, 0, 0, size, size)

      imgB.onload = () => {
        ctxB.fillStyle = 'white'
        ctxB.fillRect(0, 0, size, size)
        ctxB.drawImage(imgB, 0, 0, size, size)

        const dataA = ctxA.getImageData(0, 0, size, size).data
        const dataB = ctxB.getImageData(0, 0, size, size).data

        let diff = 0
        let count = 0

        for (let i = 0; i < dataA.length; i += 4) {
          const grayA = (dataA[i] + dataA[i+1] + dataA[i+2]) / 3
          const grayB = (dataB[i] + dataB[i+1] + dataB[i+2]) / 3

          diff += Math.abs(grayA - grayB)
          count++
        }

        const maxDiff = 255 * count
        const similarity = 1 - diff / maxDiff

        resolve(Math.max(0, similarity))
      }
      imgB.src = imgSrcB
    }
    imgA.src = imgSrcA
  })
}


document.addEventListener('contextmenu', e => {
  e.preventDefault()
})

window.addEventListener('beforeunload', () => {
  masterPassword = null
})


</script>
<div id="blurLayer" class="blur-layer"></div>
</body>
</html>
